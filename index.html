<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover, shrink-to-fit=no" />
  <title>BADGEBOX - Sistema Timbrature</title>

  <!-- PWA Meta -->
  <meta name="theme-color" content="#0d1b2b" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="BADGEBOX" />

  <!-- Icone PWA ottimizzate -->
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/badgenode-192.png" />
  <link rel="manifest" href="manifest.json" />

  <!-- Performance optimizations -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://txmjqrnitfsiytbytxlc.supabase.co" crossorigin>
  <link rel="preload" href="style.css" as="style">

  <!-- Stili -->
  <link rel="stylesheet" href="style.css" />

  
</head>
<body>
  <div class="main-container">
    <img src="assets/icons/BNLOGO.png" alt="BADGENODE" class="logo" style="width: 160px; height: auto; margin-bottom: 20px;" />
    <input type="text" id="pinInput" class="pin-display" placeholder="PIN" readonly maxlength="4" />
    <div id="status" class="status-message"></div>
    <div class="keypad">
      <button class="keypad-button">1</button>
      <button class="keypad-button">2</button>
      <button class="keypad-button">3</button>
      <button class="keypad-button">4</button>
      <button class="keypad-button">5</button>
      <button class="keypad-button">6</button>
      <button class="keypad-button">7</button>
      <button class="keypad-button">8</button>
      <button class="keypad-button">9</button>
      <button class="keypad-button">C</button>
      <button class="keypad-button">0</button>
      <button class="keypad-button" id="settings-btn" type="button" title="Impostazioni" aria-label="Impostazioni">‚öôÔ∏è</button>
    </div>
    <div class="date-time-section">
      <div class="date-text" id="dataGiorno"></div>
      <div class="time-text" id="ora"></div>
    </div>
    <div class="action-buttons">
      <button class="action-button entrata">Entrata</button>
      <button class="action-button uscita">Uscita</button>
    </div>
  </div>

  <!-- üöÄ Entry Point Unico - ES Module -->
  <script type="module" src="main.js?v=20250112"></script>

  <script>
    // ‚ö†Ô∏è SCRIPT INLINE: Solo logica timbrature (non duplicabile in ES modules)

    let timbraturaInCorso = false; // Flag per prevenire doppi invii
    
    async function registraTimbratura(tipo) {
      const pin = pinInput.value.trim();
      if (!pin) {
        mostraStatus("Inserisci il PIN", "warning");
        return;
      }

      // Debouncing per prevenire doppi click
      if (timbraturaInCorso) {
        return;
      }
      timbraturaInCorso = true;

      try {
        mostraStatus("Verifica in corso...", "loading");

        if (!window.supabase) {
          mostraStatus("Errore: connessione database non disponibile", "error");
          return;
        }

        const { data: utente, error: erroreUtente } = await window.supabase
          .from("utenti")
          .select("*")
          .eq("pin", parseInt(pin))
          .single();

        if (erroreUtente || !utente) {
          mostraStatus("PIN non valido", "error");
          return;
        }

        // Controllo anti-duplicazione
        const { data: ultimaTimbratura, error: erroreUltima } = await window.supabase
          .from("timbrature")
          .select("tipo, created_at, data, ore")
          .eq("pin", parseInt(pin))
          .order("created_at", { ascending: false })
          .limit(1);

        if (erroreUltima && erroreUltima.code !== 'PGRST116') {
          console.error("Errore verifica ultima timbratura:", erroreUltima);
          mostraStatus("Errore di sistema", "error");
          return;
        }

        if (ultimaTimbratura && ultimaTimbratura.length > 0) {
          const ultimoTipo = ultimaTimbratura[0].tipo;
          if (ultimoTipo === tipo) {
            const ultimaData = ultimaTimbratura[0].data;
            const ultimaOra = ultimaTimbratura[0].ore;
            const messaggioBlocco = tipo === "entrata" ? 
              `‚ö†Ô∏è ENTRATA gi√† registrata!\nUltima: ${ultimaData} ${ultimaOra.slice(0,5)}\n\nDevi prima fare l'USCITA.` :
              `‚ö†Ô∏è USCITA gi√† registrata!\nUltima: ${ultimaData} ${ultimaOra.slice(0,5)}\n\nDevi prima fare l'ENTRATA.`;
            mostraStatus(messaggioBlocco, "error", 8000);
            return;
          }
        }

        // Usa Date nativo JavaScript con timezone Europe/Rome
        const ora = new Date();
        const oraItalia = new Date(ora.toLocaleString("en-US", {timeZone: "Europe/Rome"}));
        
        // Calcolo giorno logico (timbrature 00:00-04:59 ‚Üí giorno precedente)
        let giornoLogico = new Date(oraItalia);
        if (oraItalia.getHours() >= 0 && oraItalia.getHours() < 5) {
          giornoLogico.setDate(giornoLogico.getDate() - 1);
        }

        const dataFormatted = oraItalia.toISOString().split('T')[0]; // YYYY-MM-DD
        const oraFormatted = oraItalia.toTimeString().slice(0, 8); // HH:mm:ss
        const giornoLogicoFormatted = giornoLogico.toISOString().split('T')[0];

        const nuovaTimbratura = {
          tipo, 
          pin: parseInt(pin), 
          nome: utente.nome, 
          cognome: utente.cognome,
          data: dataFormatted, 
          ore: oraFormatted,
          giornologico: giornoLogicoFormatted
        };

        const { error } = await window.supabase
          .from('timbrature')
          .insert([nuovaTimbratura]);

        if (error) {
          console.error("Errore inserimento timbratura:", error);
          throw new Error("Errore durante la registrazione: " + error.message);
        }

        const oraDisplay = oraFormatted.slice(0, 5); // HH:mm
        mostraStatus(`${utente.nome} ${utente.cognome}\n${tipo.toUpperCase()} ${oraDisplay}`, "success", 7000);
        pinInput.value = '';

      } catch (e) {
        console.error("Errore generale:", e);
        mostraStatus(e.message || "Errore di connessione", "error", 6000);
      } finally {
        // Reset flag dopo 300ms per prevenire doppi invii
        setTimeout(() => {
          timbraturaInCorso = false;
        }, 300);
      }
    }

    // Event listeners pulsanti azione
    document.querySelector(".entrata").addEventListener("click", () => {
      if (!pinInput.value.trim()) {
        mostraStatus("Inserisci il PIN", "warning");
        return;
      }
      registraTimbratura("entrata");
    });

    document.querySelector(".uscita").addEventListener("click", () => {
      if (!pinInput.value.trim()) {
        mostraStatus("Inserisci il PIN", "warning");
        return;
      }
      registraTimbratura("uscita");
    });

    // Inizializzazione gestita da main.js
  </script>

</body>
</html>