<!DOCTYPE html>
<html lang="it">
<head>
  <script>
  // Disabilita completamente HMR/WebSocket per prevenire ricaricamenti
  (function () {
    // Block ALL WebSocket connections in dev
    if (window.WebSocket) {
      window.WebSocket = function() {
        console.debug('[HMR] WebSocket completamente disabilitato');
        return { close(){}, readyState: 3, addEventListener(){}, removeEventListener(){}, send(){} };
      };
    }
    
    // Block ALL EventSource connections
    if (window.EventSource) {
      window.EventSource = function() {
        console.debug('[HMR] EventSource completamente disabilitato');
        return { close(){}, readyState: 2, onopen:null, onmessage:null, onerror:null, addEventListener(){}, removeEventListener(){} };
      };
    }
  })();
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover, shrink-to-fit=no" />
  
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4bWpxcm5pdGZzaXl0Ynl0eGxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1MzY1MDcsImV4cCI6MjA2NzExMjUwN30.lag16Oxh_UQL4WOeU9-pVxIzvUyiNQMhKUY5Y5s9DPg">
  <title>Storico Timbrature - BADGEBOX</title>

  <!-- PWA Meta -->
  <meta name="theme-color" content="#0d1b2b" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="BADGEBOX" />

  <!-- Icone PWA -->
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/badgenode-192.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/badgenode-192.png" />
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/badgenode-192.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/badgenode-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/badgenode-192.png" />
  <meta name="msapplication-TileImage" content="/assets/icons/badgenode-192.png" />
  <meta name="msapplication-TileColor" content="#0d1b2b" />
  <link rel="manifest" href="manifest.json" />

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://txmjqrnitfsiytbytxlc.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="https://txmjqrnitfsiytbytxlc.supabase.co">

  <!-- Preload risorse critiche -->
  <link rel="preload" href="utenti.html" as="fetch">
  <link rel="preload" href="style.css" as="style">
  <link rel="modulepreload" href="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
  <link rel="modulepreload" href="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
  

  <!-- Fonts e CSS -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="assets/styles/storico-styles.css" />
  
  <!-- CSS inline per forzare allineamento tabella -->
  <style>
    .tabella-header table,
    .tabella-body-wrapper table,
    .tabella-footer table {
      border-collapse: collapse !important;
      table-layout: fixed !important;
      width: 100% !important;
    }
    
    .tabella-header th:nth-child(1),
    .tabella-body-wrapper td:nth-child(1),
    .tabella-footer td:nth-child(1) { 
      width: 120px !important;
      border-right: 1px solid #334155 !important;
    }
    
    .tabella-header th:nth-child(2),
    .tabella-body-wrapper td:nth-child(2),
    .tabella-footer td:nth-child(2) { 
      width: 110px !important;
      border-right: 1px solid #334155 !important;
    }
    
    .tabella-header th:nth-child(3),
    .tabella-body-wrapper td:nth-child(3),
    .tabella-footer td:nth-child(3) { 
      width: 80px !important;
      border-right: 1px solid #334155 !important;
    }
    
    .tabella-header th:nth-child(4),
    .tabella-body-wrapper td:nth-child(4),
    .tabella-footer td:nth-child(4) { 
      width: 80px !important;
      border-right: 1px solid #334155 !important;
    }
    
    .tabella-header th:nth-child(5),
    .tabella-body-wrapper td:nth-child(5),
    .tabella-footer td:nth-child(5) { 
      width: 70px !important;
      border-right: 1px solid #334155 !important;
    }
    
    .tabella-header th:nth-child(6),
    .tabella-body-wrapper td:nth-child(6),
    .tabella-footer td:nth-child(6) { 
      width: 70px !important;
      border-right: 1px solid #334155 !important;
    }
    
    .tabella-header th:nth-child(7),
    .tabella-body-wrapper td:nth-child(7),
    .tabella-footer td:nth-child(7) { 
      width: 50px !important;
      border-right: 1px solid #334155 !important;
    }
  </style>
</head>
<body style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%); min-height: 100vh;">
  <div class="container">
    <div id="storico-top-bar">
      <button id="torna-utenti" class="btn-torna-utenti" title="Torna a Utenti">
        â¬…
      </button>

      <div class="header-fisso">
        <div style="position: relative; text-align: center; margin-bottom: 10px;">
          <img src="assets/icons/BNLOGO.png" alt="BADGENODE" style="width: 120px; height: auto; margin-bottom: 15px;" />
          <p class="titolo-piccolo">Storico Timbrature</p>
          <h1 id="intestazione" class="titolo-grande">Nome Cognome</h1>
        </div>

        <div class="filtro-e-pulsanti">
          <div class="filtro-temporale">
            <select id="filtro-mese">
              <option value="corrente">Mese corrente</option>
              <option value="precedente">Mese precedente</option>
              <option value="due-precedenti">2 mesi precedenti</option>
            </select>
            <div class="data-container">
              <input type="date" id="data-inizio" />
              <img src="/assets/icons/calendario.png" class="icona-calendario-campo" alt="Calendario" data-campo="data-inizio" />
            </div>
            <div class="data-container">
              <input type="date" id="data-fine" />
              <img src="/assets/icons/calendario.png" class="icona-calendario-campo" alt="Calendario" data-campo="data-fine" />
            </div>
          </div>

          <div class="pulsanti-alto">
            <button id="btn-invia" title="Scarica PDF">
              <div class="btn-icon pdf-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14,2 14,8 20,8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                  <polyline points="10,9 9,9 8,9"/>
                </svg>
                <span class="btn-label">PDF</span>
              </div>
            </button>
            <button id="btn-excel" title="Esporta Excel">
              <div class="btn-icon excel-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14,2 14,8 20,8"/>
                  <rect x="8" y="13" width="8" height="7"/>
                  <line x1="8" y1="13" x2="16" y2="20"/>
                  <line x1="16" y1="13" x2="8" y2="20"/>
                </svg>
                <span class="btn-label">XLS</span>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="tabella-wrapper">
      <div class="tabella-container">
        <div class="filtri-sezione">
      <div id="messaggioRange" style="display: none; color: #ff6b6b; background: #ffe8e8; padding: 8px; border-radius: 4px; margin-bottom: 10px;"></div>
</div>
        <div class="tabella-header">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Mese</th>
                <th>Entrata</th>
                <th>Uscita</th>
                <th>Ore</th>
                <th>Extra</th>
                <th>Modifica</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="tabella-body-wrapper">
          <table>
            <tbody id="storico-body" data-rec003-off></tbody>
          </table>
        </div>
        <div class="tabella-footer">
          <table>
            <tbody id="totale-footer">
              <tr>
                <td style="text-align:left;">TOTALE MENSILE</td>
                <td></td>
                <td></td>
                <td></td>
                <td style="color: #ffff99;"></td>
                <td style="text-align: center;"></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Overlay per modifica timbrature -->
  <div id="modalOverlay">
    <div id="modal">
      <h2>Modifica Timbrature</h2>
      <form id="modaleForm">
        <label for="modale-data-entrata">Data Entrata:</label>
        <input type="date" id="modale-data-entrata" />
        <label for="modale-entrata">Ora Entrata:</label>
        <input type="time" id="modale-entrata" />

        <label for="modale-data-uscita">Data Uscita:</label>
        <input type="date" id="modale-data-uscita" />
        <label for="modale-uscita">Ora Uscita:</label>
        <input type="time" id="modale-uscita" />

        <div class="modal-btns">
          <button type="button" id="btnSalva">Salva</button>
          <button type="button" id="btnElimina">Elimina</button>
          <button type="button" id="btnChiudi">Chiudi</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ðŸš€ Entry Point Unico - ES Modules con percorsi assoluti -->
  <script type="module" src="./assets/scripts/supabase-client.js"></script>
  <script type="module" src="./assets/scripts/storico-logic.js"></script>
  <script type="module" src="./assets/scripts/timbrature-render.js"></script>

<script>
/* REC-SW-GUARD-ALL */
(function(){
  try{
    const host = location.hostname, port = location.port;
    const isDev = host==='localhost' || host.includes('replit.dev') || port==='5000' || port==='5173';
    const is8080 = port==='8080';
    const isRender = /\.onrender\.com$/.test(host);
    if ('serviceWorker' in navigator) {
      if (isDev || is8080 || isRender || (new URLSearchParams(location.search)).get('no-sw')==='1') {
        navigator.serviceWorker.getRegistrations?.().then(rs=>rs.forEach(r=>r.unregister().catch(()=>{})));
        if ('caches' in window) caches.keys().then(ns=>ns.forEach(n=>caches.delete(n).catch(()=>{})));
        console.info('[SW] Unregistered (env guard)');
      } else {
        const swPath='/sw.js';
        fetch(swPath,{method:'HEAD'}).then(r=>{
          if(r&&r.ok) navigator.serviceWorker.register(swPath).catch(()=>{});
          else console.info('[SW] Not found, skip');
        }).catch(()=>console.info('[SW] Skip'));
      }
    }
  }catch(e){ console.info('[SW] guard error', e?.message||e); }
})();
</script>
<!-- removed extra </body> -->
<script type="module">
/* REC003-FORCE â€” trigger manuale per attivare la VirtualTable a prescindere dal numero di righe */
try{
  window.__REC003__ = window.__REC003__ || {};
  window.__REC003__.force = ()=>{
    try{
      const tb = document.querySelector('#storico-body');
      if(!tb){ console.warn('[REC003] force: tbody #storico-body non trovato'); return; }
      const trs = tb.querySelectorAll('tr');
      const rowsHTML = Array.from(trs, tr => tr.outerHTML);
      if(window.__REC003__?.mount){
        window.__REC003__.mount(rowsHTML);
        console.info('[REC003] VirtualTable attiva (force)', rowsHTML.length, 'righe');
      } else {
        console.warn('[REC003] force: mount non disponibile');
      }
    }catch(e){ console.warn('[REC003] force errore:', e?.message||e); }
  };
}catch(e){ console.warn('[REC003] force non definito:', e?.message||e); }
</script>
<script type="module">import { VirtualTable } from './assets/scripts/virtual-table.js'; window.__REC003__ = window.__REC003__ || {}; window.__REC003__.mount = (rowsHTML)=>{   try{     const tb = document.querySelector('#storico-body');     if(!tb) return console.warn('[REC003] tbody non trovato');     const vt = new VirtualTable(tb,{ rowHeight: 44, buffer: 12 });     vt.setRows(rowsHTML);     console.info('[REC003] virtual table attiva:', rowsHTML?.length||0, 'righe');   }catch(e){ console.warn('[REC003] fallback renderer:', e?.message||e); } };</script>
<script type="module">
/* REC003-AUTOWIRE â€” attiva VirtualTable in automatico, nessun cambio layout */
document.addEventListener('DOMContentLoaded',()=>{
  try{
    const tb = document.querySelector('#storico-body');
    if(!tb) return;
    if(tb.hasAttribute('data-rec003-off')) { console.info('[REC003] autowire disattivato via data-rec003-off'); return; }
    let armed = false;
    const run = ()=>{
      if(armed) return;
      const trs = tb.querySelectorAll('tr');
      if(trs.length > 20){
        const rowsHTML = Array.from(trs, tr => tr.outerHTML);
        if(window.__REC003__?.mount){
          window.__REC003__.mount(rowsHTML);
          console.info('[REC003] VirtualTable attiva (autowire)', rowsHTML.length, 'righe');
          armed = true;
          obs.disconnect();
        }
      }
    };
    const obs = new MutationObserver(()=>{ try{ run(); }catch(e){ console.warn('[REC003] autowire fallback:', e?.message||e); } });
    obs.observe(tb, { childList:true });
    /* tentativo anche se la tabella Ã¨ giÃ  pronta */
    setTimeout(()=>{ try{ run(); }catch{} }, 0);
  }catch(e){ console.warn('[REC003] autowire non attivo:', e?.message||e); }
});
</script>
<script type="module">import { fetchStoricoJoin } from './assets/scripts/rec004_join_adapter.js'; window.__REC004__ = { fetchStoricoJoin };</script>

  <script>
    document.getElementById("torna-utenti")?.addEventListener("click", () => {
      window.location.href = "utenti.html";
    });
  </script>

  <!-- PWA SW block removed -->
</body>
</html>
